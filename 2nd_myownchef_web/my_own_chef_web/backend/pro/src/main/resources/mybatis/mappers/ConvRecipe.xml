<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moc.pro.convrecipe.dao.ConvRecipeDAO">

    <!-- ConvRecipe ResultMap -->
    <resultMap id="ConvRecipeResultMap" type="com.moc.pro.convrecipe.vo.ConvRecipeVO">
        <id property="convRecipeId" column="CONV_COMB_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="convRecipeTitle" column="CONV_COMB_TITLE"/>
        <result property="convRecipeMainProduct" column="CONV_COMB_MAIN_PRODUCT"/>
        <result property="convRecipeCategory" column="CONV_COMB_CATEGORY"/>
        <result property="convRecipeTip" column="CONV_COMB_TIP"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="userNickname" column="USER_NICKNAME"/>
        <result property="firstImageUrl" column="FIRST_IMAGE_URL"/>
    </resultMap>
    
    <!-- ConvRecipeComment ResultMap -->
    <resultMap id="ConvRecipeCommentResultMap" type="com.moc.pro.convrecipe.vo.ConvRecipeCommentVO">
        <id property="convRecipeCommentId" column="CONV_COMB_COMMENT_ID"/>
        <result property="convRecipeId" column="CONV_COMB_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="convRecipeCommentContent" column="CONV_COMB_COMMENT_CONTENT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="userNickname" column="USER_NICKNAME"/>
    </resultMap>
    
    <!-- ConvRecipeProduct ResultMap -->
    <resultMap id="ConvRecipeProductResultMap" type="com.moc.pro.convrecipe.vo.ConvRecipeProductVO">
        <id property="convRecipeProductId" column="CONV_COMB_PRODUCT_ID"/>
        <result property="convRecipeId" column="CONV_COMB_ID"/>
        <result property="convRecipeProductContent" column="CONV_COMB_PRODUCT_CONTENT"/>
        <result property="convRecipeProductIndex" column="CONV_COMB_PRODUCT_INDEX"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
    </resultMap>
    
    <!-- ConvRecipeOrder ResultMap -->
    <resultMap id="ConvRecipeOrderResultMap" type="com.moc.pro.convrecipe.vo.ConvRecipeOrderVO">
        <id property="convRecipeOrderId" column="CONV_COMB_RECIPE_ID"/>
        <result property="convRecipeId" column="CONV_COMB_ID"/>
        <result property="convRecipeOrderContent" column="CONV_COMB_RECIPE_CONTENT"/>
        <result property="convRecipeOrderIndex" column="CONV_COMB_RECIPE_INDEX"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
    </resultMap>
    
    <!-- ConvRecipeImage ResultMap -->
    <resultMap id="ConvRecipeImageResultMap" type="com.moc.pro.convrecipe.vo.ConvRecipeImageVO">
        <id property="convRecipeImageId" column="CONV_COMB_IMAGE_ID"/>
        <result property="convRecipeId" column="CONV_COMB_ID"/>
        <result property="convRecipeImageUrl" column="CONV_COMB_IMAGE_URL"/>
        <result property="convRecipeImagePath" column="CONV_COMB_IMAGE_PATH"/>
        <result property="convRecipeImageIndex" column="CONV_COMB_IMAGE_INDEX"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
    </resultMap>

    <!-- 편의점 조합 목록 조회 (카테고리 필터 + 페이징) -->
    <select id="selectList" parameterType="map" resultMap="ConvRecipeResultMap">
        SELECT 
            cr.CONV_COMB_ID,
            cr.USER_ID,
            cr.CONV_COMB_TITLE,
            cr.CONV_COMB_MAIN_PRODUCT,
            cr.CONV_COMB_CATEGORY,
            cr.CREATED_AT,
            u.USER_NICKNAME,
            (
             SELECT CONV_COMB_IMAGE_URL
             FROM (SELECT CCI.CONV_COMB_IMAGE_URL
                FROM TB_CONV_COMB_IMAGE CCI
                WHERE CCI.CONV_COMB_ID = cr.CONV_COMB_ID
                ORDER BY CCI.CONV_COMB_IMAGE_INDEX ASC
            )
             WHERE ROWNUM = 1 
        ) AS FIRST_IMAGE_URL
        FROM TB_CONV_COMB cr
        LEFT JOIN TB_USER u ON cr.USER_ID = u.USER_ID
        <where>
            <if test="category != null and category != ''">
                AND cr.CONV_COMB_CATEGORY = #{category}
            </if>
        </where>
        ORDER BY cr.CREATED_AT DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- 전체 개수 조회 (필터 포함) -->
    <select id="selectTotalCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TB_CONV_COMB cr
        <where>
            <if test="category != null and category != ''">
                AND cr.CONV_COMB_CATEGORY = #{category}
            </if>
        </where>
    </select>

    <!-- 검색 (키워드 + 핵심제품 + 카테고리 필터) -->
    <select id="searchByKeyword" parameterType="map" resultMap="ConvRecipeResultMap">
        SELECT 
            cr.CONV_COMB_ID,
            cr.USER_ID,
            cr.CONV_COMB_TITLE,
            cr.CONV_COMB_MAIN_PRODUCT,
            cr.CONV_COMB_CATEGORY,
            cr.CREATED_AT,
            u.USER_NICKNAME,
        (SELECT CONV_COMB_IMAGE_URL
        FROM (
        SELECT CCI.CONV_COMB_IMAGE_URL
        FROM TB_CONV_COMB_IMAGE CCI
        WHERE CCI.CONV_COMB_ID = cr.CONV_COMB_ID
        ORDER BY CCI.CONV_COMB_IMAGE_INDEX ASC
        )
        WHERE ROWNUM = 1
        ) AS FIRST_IMAGE_URL
        FROM TB_CONV_COMB cr
        LEFT JOIN TB_USER u ON cr.USER_ID = u.USER_ID
        <where>
            <if test="keyword != null and keyword != ''">
                (
                cr.CONV_COMB_TITLE LIKE '%' || #{keyword} || '%'
                OR cr.CONV_COMB_TIP LIKE '%' || #{keyword} || '%'
                )
            </if>
            <if test="product != null and product != ''">
                AND cr.CONV_COMB_MAIN_PRODUCT LIKE '%' || #{product} || '%'
            </if>
            <if test="category != null and category != ''">
                AND cr.CONV_COMB_CATEGORY = #{category}
            </if>
        </where>
        ORDER BY cr.CREATED_AT DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- 검색 결과 개수 -->
    <select id="selectSearchCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TB_CONV_COMB cr
        <where>
            <if test="keyword != null and keyword != ''">
                (cr.CONV_COMB_TITLE LIKE '%' || #{keyword} || '%'
                OR cr.CONV_COMB_TIP LIKE '%' || #{keyword} || '%')
            </if>
            <if test="product != null and product != ''">
                AND cr.CONV_COMB_MAIN_PRODUCT LIKE '%' || #{product} || '%'
            </if>
            <if test="category != null and category != ''">
                AND cr.CONV_COMB_CATEGORY = #{category}
            </if>
        </where>
    </select>

    <!-- 상세 조회 -->
    <select id="selectById" parameterType="int" resultMap="ConvRecipeResultMap">
        SELECT 
            cr.*,
            u.USER_NICKNAME
        FROM TB_CONV_COMB cr
        LEFT JOIN TB_USER u ON cr.USER_ID = u.USER_ID
        WHERE cr.CONV_COMB_ID = #{convRecipeId}
    </select>

    <!-- 작성 -->
    <insert id="insertConvRecipe" parameterType="com.moc.pro.convrecipe.vo.ConvRecipeVO" 
            useGeneratedKeys="true" keyProperty="convRecipeId" keyColumn="CONV_COMB_ID">
        INSERT INTO TB_CONV_COMB (
            USER_ID,
            CONV_COMB_TITLE,
            CONV_COMB_MAIN_PRODUCT,
            CONV_COMB_CATEGORY,
            CONV_COMB_TIP,
            CREATED_AT,
            CREATED_BY
        ) VALUES (
            #{userId},
            #{convRecipeTitle},
            #{convRecipeMainProduct},
            #{convRecipeCategory},
            #{convRecipeTip},
            SYSTIMESTAMP,
            #{userId}
        )
    </insert>

    <!-- 수정 -->
    <update id="updateConvRecipe" parameterType="com.moc.pro.convrecipe.vo.ConvRecipeVO">
        UPDATE TB_CONV_COMB
        SET CONV_COMB_TITLE = #{convRecipeTitle},
            CONV_COMB_MAIN_PRODUCT = #{convRecipeMainProduct},
            CONV_COMB_CATEGORY = #{convRecipeCategory},
            CONV_COMB_TIP = #{convRecipeTip},
            UPDATED_AT = SYSTIMESTAMP,
            UPDATED_BY = #{userId}
        WHERE CONV_COMB_ID = #{convRecipeId}
    </update>

    <!-- 삭제 -->
    <delete id="deleteConvRecipe" parameterType="int">
        DELETE FROM TB_CONV_COMB WHERE CONV_COMB_ID = #{convRecipeId}
    </delete>

    <!-- 작성자 확인 -->
    <select id="checkAuthor" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TB_CONV_COMB
        WHERE CONV_COMB_ID = #{convRecipeId}
          AND USER_ID = #{userId}
    </select>

    <!-- ================ 제품 관련 ================ -->
    
    <!-- 제품 목록 조회 -->
    <select id="selectProductsByRecipeId" parameterType="int" resultMap="ConvRecipeProductResultMap">
        SELECT *
        FROM TB_CONV_COMB_PRODUCT
        WHERE CONV_COMB_ID = #{convRecipeId}
        ORDER BY CONV_COMB_PRODUCT_INDEX ASC
    </select>

    <!-- 제품 추가 -->
    <insert id="insertProduct" parameterType="com.moc.pro.convrecipe.vo.ConvRecipeProductVO">
        INSERT INTO TB_CONV_COMB_PRODUCT (
            CONV_COMB_ID,
            CONV_COMB_PRODUCT_CONTENT,
            CONV_COMB_PRODUCT_INDEX,
            CREATED_AT,
            CREATED_BY
        ) VALUES (
            #{convRecipeId},
            #{convRecipeProductContent},
            #{convRecipeProductIndex},
            SYSTIMESTAMP,
            'system'
        )
    </insert>

    <!-- 제품 전체 삭제 -->
    <delete id="deleteProductsByRecipeId" parameterType="int">
        DELETE FROM TB_CONV_COMB_PRODUCT
        WHERE CONV_COMB_ID = #{convRecipeId}
    </delete>

    <!-- ================ 조리 순서 관련 ================ -->
    
    <!-- 조리 순서 조회 -->
    <select id="selectOrdersByRecipeId" parameterType="int" resultMap="ConvRecipeOrderResultMap">
        SELECT *
        FROM TB_CONV_COMB_RECIPE
        WHERE CONV_COMB_ID = #{convRecipeId}
        ORDER BY CONV_COMB_RECIPE_INDEX ASC
    </select>

    <!-- 조리 순서 추가 -->
    <insert id="insertOrder" parameterType="com.moc.pro.convrecipe.vo.ConvRecipeOrderVO">
        INSERT INTO TB_CONV_COMB_RECIPE (
            CONV_COMB_ID,
            CONV_COMB_RECIPE_CONTENT,
            CONV_COMB_RECIPE_INDEX,
            CREATED_AT,
            CREATED_BY
        ) VALUES (
            #{convRecipeId},
            #{convRecipeOrderContent},
            #{convRecipeOrderIndex},
            SYSTIMESTAMP,
            'system'
        )
    </insert>

    <!-- 조리 순서 전체 삭제 -->
    <delete id="deleteOrdersByRecipeId" parameterType="int">
        DELETE FROM TB_CONV_COMB_RECIPE
        WHERE CONV_COMB_ID = #{convRecipeId}
    </delete>

    <!-- ================ 이미지 관련 ================ -->
    
    <!-- 이미지 목록 조회 -->
    <select id="selectImagesByRecipeId" parameterType="int" resultMap="ConvRecipeImageResultMap">
        SELECT *
        FROM TB_CONV_COMB_IMAGE
        WHERE CONV_COMB_ID = #{convRecipeId}
        ORDER BY CONV_COMB_IMAGE_INDEX ASC
    </select>

    <!-- 이미지 추가 -->
    <insert id="insertImage" parameterType="com.moc.pro.convrecipe.vo.ConvRecipeImageVO">
        INSERT INTO TB_CONV_COMB_IMAGE (
            CONV_COMB_ID,
            CONV_COMB_IMAGE_URL,
            CONV_COMB_IMAGE_PATH,
            CONV_COMB_IMAGE_INDEX,
            CREATED_AT,
            CREATED_BY
        ) VALUES (
            #{convRecipeId},
            #{convRecipeImageUrl},
            #{convRecipeImagePath},
            #{convRecipeImageIndex},
            SYSTIMESTAMP,
            'system'
        )
    </insert>

    <!-- 이미지 전체 삭제 -->
    <delete id="deleteImagesByRecipeId" parameterType="int">
        DELETE FROM TB_CONV_COMB_IMAGE
        WHERE CONV_COMB_ID = #{convRecipeId}
    </delete>

    <!-- 이미지 개별 삭제 -->
    <delete id="deleteImageById" parameterType="int">
        DELETE FROM TB_CONV_COMB_IMAGE
        WHERE CONV_COMB_IMAGE_ID = #{imageId}
    </delete>

    <!-- ================ 댓글 관련 ================ -->
    
    <!-- 댓글 목록 조회 -->
    <select id="selectCommentsByRecipeId" parameterType="int" resultMap="ConvRecipeCommentResultMap">
        SELECT 
            c.*,
            u.USER_NICKNAME
        FROM TB_CONV_COMB_COMMENT c
        LEFT JOIN TB_USER u ON c.USER_ID = u.USER_ID
        WHERE c.CONV_COMB_ID = #{convRecipeId}
        ORDER BY c.CREATED_AT ASC
    </select>

    <!-- 댓글 작성 -->
    <insert id="insertComment" parameterType="com.moc.pro.convrecipe.vo.ConvRecipeCommentVO">
        INSERT INTO TB_CONV_COMB_COMMENT (
            CONV_COMB_ID,
            USER_ID,
            CONV_COMB_COMMENT_CONTENT,
            CREATED_AT,
            CREATED_BY
        ) VALUES (
            #{convRecipeId},
            #{userId},
            #{convRecipeCommentContent},
            SYSTIMESTAMP,
            #{userId}
        )
    </insert>

    <!-- 댓글 삭제 -->
    <delete id="deleteComment" parameterType="int">
        DELETE FROM TB_CONV_COMB_COMMENT
        WHERE CONV_COMB_COMMENT_ID = #{commentId}
    </delete>

    <!-- 댓글 작성자 확인 -->
    <select id="checkCommentAuthor" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TB_CONV_COMB_COMMENT
        WHERE CONV_COMB_COMMENT_ID = #{commentId}
          AND USER_ID = #{userId}
    </select>

</mapper>
