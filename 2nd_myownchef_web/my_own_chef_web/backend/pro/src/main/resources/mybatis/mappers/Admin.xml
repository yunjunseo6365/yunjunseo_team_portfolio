<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moc.pro.admin.dao.AdminDAO">

    <!-- AdminUserVO ResultMap -->
    <resultMap id="AdminUserResultMap" type="com.moc.pro.admin.vo.AdminUserVO">
        <result property="userId" column="userId"/>
        <result property="userName" column="userName"/>
        <result property="userNickname" column="userNickname"/>
        <result property="userEmail" column="userEmail"/>
        <result property="createdAt" column="createdAt"/>
        <result property="userStatus" column="userStatus"/>
    </resultMap>

    <!-- AdminPostVO ResultMap -->
    <resultMap id="AdminPostResultMap" type="com.moc.pro.admin.vo.AdminPostVO">
        <result property="postId" column="postId"/>
        <result property="userNickname" column="userNickname"/>
        <result property="title" column="title"/>
        <result property="createdAt" column="createdAt"/>
        <result property="category" column="category"/>
        <result property="boardType" column="boardType"/>
    </resultMap>

    <!-- ========== 회원 관리 쿼리 ========== -->

    <!-- 회원 목록 조회 (검색 + 페이징) -->
    <select id="selectUsers" parameterType="map" resultMap="AdminUserResultMap">
        SELECT 
            USER_ID as userId,
            USER_NAME as userName,
            USER_NICKNAME as userNickname,
            USER_EMAIL as userEmail,
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD') as createdAt,
            USER_STATUS as userStatus
        FROM TB_USER
        WHERE USER_STATUS != 'WITHDRAWN'
        <if test="nickname != null and nickname != ''">
            AND USER_NICKNAME LIKE '%' || #{nickname} || '%'
        </if>
        ORDER BY CREATED_AT DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- 회원 전체 개수 (검색 포함) -->
    <select id="selectUsersTotalCount" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM TB_USER
        WHERE USER_STATUS != 'WITHDRAWN'
        <if test="nickname != null and nickname != ''">
            AND USER_NICKNAME LIKE '%' || #{nickname} || '%'
        </if>
    </select>

    <!-- 회원 삭제 (논리 삭제 - USER_STATUS = 'WITHDRAWN') -->
    <update id="deleteUser" parameterType="string">
        UPDATE TB_USER
        SET USER_STATUS = 'WITHDRAWN',
            WITHDRAWN_AT = SYSTIMESTAMP,
            UPDATED_AT = SYSTIMESTAMP,
            UPDATED_BY = 'ADMIN'
        WHERE USER_ID = #{userId}
    </update>

    <!-- ========== 게시글 관리 쿼리 ========== -->

    <!-- 게시글 목록 조회 (UNION ALL + 검색 + 페이징) -->
    <select id="selectPosts" parameterType="map" resultMap="AdminPostResultMap">
        SELECT * FROM (
            SELECT 
                RECIPE_ID as postId,
                (SELECT USER_NICKNAME FROM TB_USER WHERE USER_ID = r.USER_ID) as userNickname,
                RECIPE_TITLE as title,
                TO_CHAR(CREATED_AT, 'YYYY-MM-DD') as createdAt,
                '레시피 게시판' as category,
                'recipe' as boardType
            FROM TB_RECIPE r
            WHERE 1=1
            <if test="title != null and title != ''">
                AND RECIPE_TITLE LIKE '%' || #{title} || '%'
            </if>
            <if test="categories != null and categories.size() > 0">
                AND '레시피 게시판' IN
                <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                    #{cat}
                </foreach>
            </if>
            
            UNION ALL
            
            SELECT 
                FREEBOARD_ID,
                (SELECT USER_NICKNAME FROM TB_USER WHERE USER_ID = fb.USER_ID),
                FREEBOARD_TITLE,
                TO_CHAR(CREATED_AT, 'YYYY-MM-DD'),
                '자유게시판',
                'freeboard'
            FROM TB_FREEBOARD fb
            WHERE 1=1
            <if test="title != null and title != ''">
                AND FREEBOARD_TITLE LIKE '%' || #{title} || '%'
            </if>
            <if test="categories != null and categories.size() > 0">
                AND '자유게시판' IN
                <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                    #{cat}
                </foreach>
            </if>
            
            UNION ALL
            
            SELECT 
                SHARETOOL_ID,
                (SELECT USER_NICKNAME FROM TB_USER WHERE USER_ID = st.USER_ID),
                SHARETOOL_TITLE,
                TO_CHAR(CREATED_AT, 'YYYY-MM-DD'),
                '요리도구 나눔',
                'sharetool'
            FROM TB_SHARETOOL st
            WHERE 1=1
            <if test="title != null and title != ''">
                AND SHARETOOL_TITLE LIKE '%' || #{title} || '%'
            </if>
            <if test="categories != null and categories.size() > 0">
                AND '요리도구 나눔' IN
                <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                    #{cat}
                </foreach>
            </if>
            
            UNION ALL
            
            SELECT 
                CONV_REVIEW_ID,
                (SELECT USER_NICKNAME FROM TB_USER WHERE USER_ID = cr.USER_ID),
                CONV_REVIEW_TITLE,
                TO_CHAR(CREATED_AT, 'YYYY-MM-DD'),
                '편의점 - 신제품',
                'conv-review'
            FROM TB_CONV_REVIEW cr
            WHERE 1=1
            <if test="title != null and title != ''">
                AND CONV_REVIEW_TITLE LIKE '%' || #{title} || '%'
            </if>
            <if test="categories != null and categories.size() > 0">
                AND '편의점 - 신제품' IN
                <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                    #{cat}
                </foreach>
            </if>
            
            UNION ALL
            
            SELECT 
                CONV_COMB_ID,
                (SELECT USER_NICKNAME FROM TB_USER WHERE USER_ID = cc.USER_ID),
                CONV_COMB_TITLE,
                TO_CHAR(CREATED_AT, 'YYYY-MM-DD'),
                '편의점 - 파먹기',
                'conv-recipe'
            FROM TB_CONV_COMB cc
            WHERE 1=1
            <if test="title != null and title != ''">
                AND CONV_COMB_TITLE LIKE '%' || #{title} || '%'
            </if>
            <if test="categories != null and categories.size() > 0">
                AND '편의점 - 파먹기' IN
                <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                    #{cat}
                </foreach>
            </if>
            
            UNION ALL
            
            SELECT 
                WITHSHOPPING_ID,
                (SELECT USER_NICKNAME FROM TB_USER WHERE USER_ID = ws.USER_ID),
                WITHSHOPPING_TITLE,
                TO_CHAR(CREATED_AT, 'YYYY-MM-DD'),
                '같이장보기',
                'withshopping'
            FROM TB_WITHSHOPPING ws
            WHERE 1=1
            <if test="title != null and title != ''">
                AND WITHSHOPPING_TITLE LIKE '%' || #{title} || '%'
            </if>
            <if test="categories != null and categories.size() > 0">
                AND '같이장보기' IN
                <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                    #{cat}
                </foreach>
            </if>
            
            UNION ALL
            
            SELECT 
                NOTICE_ID,
                (SELECT USER_NICKNAME FROM TB_USER WHERE USER_ID = n.USER_ID),
                NOTICE_TITLE,
                TO_CHAR(CREATED_AT, 'YYYY-MM-DD'),
                '공지사항',
                'notice'
            FROM TB_NOTICE n
            WHERE 1=1
            <if test="title != null and title != ''">
                AND NOTICE_TITLE LIKE '%' || #{title} || '%'
            </if>
            <if test="categories != null and categories.size() > 0">
                AND '공지사항' IN
                <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                    #{cat}
                </foreach>
            </if>
        )
        ORDER BY createdAt DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- 게시글 전체 개수 (검색 포함) -->
    <select id="selectPostsTotalCount" parameterType="map" resultType="int">
        SELECT (
            (SELECT COUNT(*) FROM TB_RECIPE WHERE 1=1
                <if test="title != null and title != ''">
                    AND RECIPE_TITLE LIKE '%' || #{title} || '%'
                </if>
                <if test="categories != null and categories.size() > 0">
                    AND '레시피 게시판' IN
                    <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                        #{cat}
                    </foreach>
                </if>
            ) +
            (SELECT COUNT(*) FROM TB_FREEBOARD WHERE 1=1
                <if test="title != null and title != ''">
                    AND FREEBOARD_TITLE LIKE '%' || #{title} || '%'
                </if>
                <if test="categories != null and categories.size() > 0">
                    AND '자유게시판' IN
                    <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                        #{cat}
                    </foreach>
                </if>
            ) +
            (SELECT COUNT(*) FROM TB_SHARETOOL WHERE 1=1
                <if test="title != null and title != ''">
                    AND SHARETOOL_TITLE LIKE '%' || #{title} || '%'
                </if>
                <if test="categories != null and categories.size() > 0">
                    AND '요리도구 나눔' IN
                    <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                        #{cat}
                    </foreach>
                </if>
            ) +
            (SELECT COUNT(*) FROM TB_CONV_REVIEW WHERE 1=1
                <if test="title != null and title != ''">
                    AND CONV_REVIEW_TITLE LIKE '%' || #{title} || '%'
                </if>
                <if test="categories != null and categories.size() > 0">
                    AND '편의점 - 신제품' IN
                    <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                        #{cat}
                    </foreach>
                </if>
            ) +
            (SELECT COUNT(*) FROM TB_CONV_COMB WHERE 1=1
                <if test="title != null and title != ''">
                    AND CONV_COMB_TITLE LIKE '%' || #{title} || '%'
                </if>
                <if test="categories != null and categories.size() > 0">
                    AND '편의점 - 파먹기' IN
                    <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                        #{cat}
                    </foreach>
                </if>
            ) +
            (SELECT COUNT(*) FROM TB_WITHSHOPPING WHERE 1=1
                <if test="title != null and title != ''">
                    AND WITHSHOPPING_TITLE LIKE '%' || #{title} || '%'
                </if>
                <if test="categories != null and categories.size() > 0">
                    AND '같이장보기' IN
                    <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                        #{cat}
                    </foreach>
                </if>
            ) +
            (SELECT COUNT(*) FROM TB_NOTICE WHERE 1=1
                <if test="title != null and title != ''">
                    AND NOTICE_TITLE LIKE '%' || #{title} || '%'
                </if>
                <if test="categories != null and categories.size() > 0">
                    AND '공지사항' IN
                    <foreach collection="categories" item="cat" open="(" close=")" separator=",">
                        #{cat}
                    </foreach>
                </if>
            )
        ) AS total
        FROM DUAL
    </select>

    <!-- 게시글 삭제 (boardType별 분기) -->
    <delete id="deletePost" parameterType="map">
        <choose>
            <when test="boardType == 'recipe'">
                DELETE FROM TB_RECIPE WHERE RECIPE_ID = #{postId}
            </when>
            <when test="boardType == 'freeboard'">
                DELETE FROM TB_FREEBOARD WHERE FREEBOARD_ID = #{postId}
            </when>
            <when test="boardType == 'sharetool'">
                DELETE FROM TB_SHARETOOL WHERE SHARETOOL_ID = #{postId}
            </when>
            <when test="boardType == 'conv-review'">
                DELETE FROM TB_CONV_REVIEW WHERE CONV_REVIEW_ID = #{postId}
            </when>
            <when test="boardType == 'conv-recipe'">
                DELETE FROM TB_CONV_COMB WHERE CONV_COMB_ID = #{postId}
            </when>
            <when test="boardType == 'withshopping'">
                DELETE FROM TB_WITHSHOPPING WHERE WITHSHOPPING_ID = #{postId}
            </when>
            <when test="boardType == 'notice'">
                DELETE FROM TB_NOTICE WHERE NOTICE_ID = #{postId}
            </when>
        </choose>
    </delete>

</mapper>
