<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.moc.pro.recipe.dao.RecipeDAO">
    
    <!-- RecipeVO ResultMap -->
    <resultMap id="RecipeResultMap" type="com.moc.pro.recipe.vo.RecipeVO">
        <id property="recipeId" column="RECIPE_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="recipeTitle" column="RECIPE_TITLE"/>
        <result property="recipeMainIngredient" column="RECIPE_MAIN_INGREDIENT"/>
        <result property="recipeContent" column="RECIPE_CONTENT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="userNickname" column="USER_NICKNAME"/>
    </resultMap>
    
    <!-- RecipeCommentVO ResultMap -->
    <resultMap id="RecipeCommentResultMap" type="com.moc.pro.recipe.vo.RecipeCommentVO">
        <id property="recipeCommentId" column="RECIPE_COMMENT_ID"/>
        <result property="recipeId" column="RECIPE_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="recipeCommentContent" column="RECIPE_COMMENT_CONTENT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="userNickname" column="USER_NICKNAME"/>
    </resultMap>
    
    <!-- RecipeIngredientVO ResultMap -->
    <resultMap id="RecipeIngredientResultMap" type="com.moc.pro.recipe.vo.RecipeIngredientVO">
        <id property="recipeDetailIngredientId" column="RECIPE_DETAIL_INGREDIENT_ID"/>
        <result property="recipeId" column="RECIPE_ID"/>
        <result property="recipeDetailIngredientContent" column="RECIPE_DETAIL_INGREDIENT_CONTENT"/>
        <result property="recipeDetailIngredientIndex" column="RECIPE_DETAIL_INGREDIENT_INDEX"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
    </resultMap>
    
    <!-- RecipeOrderVO ResultMap -->
    <resultMap id="RecipeOrderResultMap" type="com.moc.pro.recipe.vo.RecipeOrderVO">
        <id property="recipeOrderId" column="RECIPE_ORDER_ID"/>
        <result property="recipeId" column="RECIPE_ID"/>
        <result property="recipeOrderContent" column="RECIPE_ORDER_CONTENT"/>
        <result property="recipeOrderIndex" column="RECIPE_ORDER_INDEX"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
    </resultMap>
    
    <!-- RecipeImageVO ResultMap -->
    <resultMap id="RecipeImageResultMap" type="com.moc.pro.recipe.vo.RecipeImageVO">
        <id property="recipeImageId" column="RECIPE_IMAGE_ID"/>
        <result property="recipeId" column="RECIPE_ID"/>
        <result property="recipeImageUrl" column="RECIPE_IMAGE_URL"/>
        <result property="recipeImagePath" column="RECIPE_IMAGE_PATH"/>
        <result property="recipeImageIndex" column="RECIPE_IMAGE_INDEX"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
    </resultMap>
    
    <!-- ===== 레시피 게시글 ===== -->
    
    <!-- 목록 조회 (페이징) -->
    <select id="selectList" parameterType="map" resultMap="RecipeResultMap">
        SELECT r.*, u.USER_NICKNAME
        FROM TB_RECIPE r
        LEFT JOIN TB_USER u ON r.USER_ID = u.USER_ID
        ORDER BY r.CREATED_AT DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>
    
    <!-- 전체 개수 -->
    <select id="selectTotalCount" resultType="int">
        SELECT COUNT(*) FROM TB_RECIPE
    </select>
    
    <!-- 검색 (키워드 + 주재료) -->
    <select id="searchByKeyword" parameterType="map" resultMap="RecipeResultMap">
        SELECT r.*, u.USER_NICKNAME
        FROM TB_RECIPE r
        LEFT JOIN TB_USER u ON r.USER_ID = u.USER_ID
        <where>
            <if test="keyword != null and keyword != ''">
                (r.RECIPE_TITLE LIKE '%' || #{keyword} || '%'
                OR r.RECIPE_CONTENT LIKE '%' || #{keyword} || '%')
            </if>
            <if test="ingredient != null and ingredient != ''">
                <if test="keyword != null and keyword != ''">
                    AND
                </if>
                r.RECIPE_MAIN_INGREDIENT LIKE '%' || #{ingredient} || '%'
            </if>
        </where>
        ORDER BY r.CREATED_AT DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>
    
    <!-- 검색 결과 개수 -->
    <select id="selectSearchCount" parameterType="map" resultType="int">
        SELECT COUNT(*) 
        FROM TB_RECIPE r
        <where>
            <if test="keyword != null and keyword != ''">
                (r.RECIPE_TITLE LIKE '%' || #{keyword} || '%'
                OR r.RECIPE_CONTENT LIKE '%' || #{keyword} || '%')
            </if>
            <if test="ingredient != null and ingredient != ''">
                <if test="keyword != null and keyword != ''">
                    AND
                </if>
                r.RECIPE_MAIN_INGREDIENT LIKE '%' || #{ingredient} || '%'
            </if>
        </where>
    </select>
    
    <!-- 상세 조회 -->
    <select id="selectById" parameterType="int" resultMap="RecipeResultMap">
        SELECT r.*, u.USER_NICKNAME
        FROM TB_RECIPE r
        LEFT JOIN TB_USER u ON r.USER_ID = u.USER_ID
        WHERE r.RECIPE_ID = #{recipeId}
    </select>
    
    <!-- 작성 -->
    <insert id="insertRecipe" parameterType="com.moc.pro.recipe.vo.RecipeVO" useGeneratedKeys="true" keyProperty="recipeId" keyColumn="RECIPE_ID">
        INSERT INTO TB_RECIPE (
            USER_ID, RECIPE_TITLE, RECIPE_MAIN_INGREDIENT, RECIPE_CONTENT,
            CREATED_AT, CREATED_BY
        ) VALUES (
            #{userId}, #{recipeTitle}, #{recipeMainIngredient}, #{recipeContent},
            SYSTIMESTAMP, #{userId}
        )
    </insert>
    
    <!-- 수정 -->
    <update id="updateRecipe" parameterType="com.moc.pro.recipe.vo.RecipeVO">
        UPDATE TB_RECIPE
        SET RECIPE_TITLE = #{recipeTitle},
            RECIPE_MAIN_INGREDIENT = #{recipeMainIngredient},
            RECIPE_CONTENT = #{recipeContent},
            UPDATED_AT = SYSTIMESTAMP,
            UPDATED_BY = #{userId}
        WHERE RECIPE_ID = #{recipeId}
    </update>
    
    <!-- 삭제 -->
    <delete id="deleteRecipe" parameterType="int">
        DELETE FROM TB_RECIPE WHERE RECIPE_ID = #{recipeId}
    </delete>
    
    <!-- 작성자 확인 -->
    <select id="checkAuthor" parameterType="map" resultType="int">
        SELECT COUNT(*) 
        FROM TB_RECIPE
        WHERE RECIPE_ID = #{recipeId}
        AND USER_ID = #{userId}
    </select>
    
    <!-- ===== 레시피 재료 ===== -->
    
    <!-- 재료 목록 조회 -->
    <select id="selectIngredientsByRecipeId" parameterType="int" resultMap="RecipeIngredientResultMap">
        SELECT *
        FROM TB_RECIPE_DETAIL_INGREDIENT
        WHERE RECIPE_ID = #{recipeId}
        ORDER BY RECIPE_DETAIL_INGREDIENT_INDEX ASC
    </select>
    
    <!-- 재료 추가 -->
    <insert id="insertIngredient" parameterType="com.moc.pro.recipe.vo.RecipeIngredientVO">
        INSERT INTO TB_RECIPE_DETAIL_INGREDIENT (
            RECIPE_ID, RECIPE_DETAIL_INGREDIENT_CONTENT, RECIPE_DETAIL_INGREDIENT_INDEX,
            CREATED_AT, CREATED_BY
        ) VALUES (
            #{recipeId}, #{recipeDetailIngredientContent}, #{recipeDetailIngredientIndex},
            SYSTIMESTAMP, #{createdBy}
        )
    </insert>
    
    <!-- 재료 삭제 (레시피 삭제 시) -->
    <delete id="deleteIngredientsByRecipeId" parameterType="int">
        DELETE FROM TB_RECIPE_DETAIL_INGREDIENT WHERE RECIPE_ID = #{recipeId}
    </delete>
    
    <!-- ===== 레시피 순서 ===== -->
    
    <!-- 순서 목록 조회 -->
    <select id="selectOrdersByRecipeId" parameterType="int" resultMap="RecipeOrderResultMap">
        SELECT *
        FROM TB_RECIPE_ORDER
        WHERE RECIPE_ID = #{recipeId}
        ORDER BY RECIPE_ORDER_INDEX ASC
    </select>
    
    <!-- 순서 추가 -->
    <insert id="insertOrder" parameterType="com.moc.pro.recipe.vo.RecipeOrderVO">
        INSERT INTO TB_RECIPE_ORDER (
            RECIPE_ID, RECIPE_ORDER_CONTENT, RECIPE_ORDER_INDEX,
            CREATED_AT, CREATED_BY
        ) VALUES (
            #{recipeId}, #{recipeOrderContent}, #{recipeOrderIndex},
            SYSTIMESTAMP, #{createdBy}
        )
    </insert>
    
    <!-- 순서 삭제 (레시피 삭제 시) -->
    <delete id="deleteOrdersByRecipeId" parameterType="int">
        DELETE FROM TB_RECIPE_ORDER WHERE RECIPE_ID = #{recipeId}
    </delete>
    
    <!-- ===== 레시피 이미지 ===== -->
    
    <!-- 이미지 목록 조회 -->
    <select id="selectImagesByRecipeId" parameterType="int" resultMap="RecipeImageResultMap">
        SELECT *
        FROM TB_RECIPE_IMAGE
        WHERE RECIPE_ID = #{recipeId}
        ORDER BY RECIPE_IMAGE_INDEX ASC
    </select>
    
    <!-- 이미지 추가 -->
    <insert id="insertImage" parameterType="com.moc.pro.recipe.vo.RecipeImageVO">
        INSERT INTO TB_RECIPE_IMAGE (
            RECIPE_ID, RECIPE_IMAGE_URL, RECIPE_IMAGE_PATH, RECIPE_IMAGE_INDEX,
            CREATED_AT, CREATED_BY
        ) VALUES (
            #{recipeId}, #{recipeImageUrl}, #{recipeImagePath}, #{recipeImageIndex},
            SYSTIMESTAMP, #{createdBy}
        )
    </insert>
    
    <!-- 이미지 삭제 (레시피 삭제 시) -->
    <delete id="deleteImagesByRecipeId" parameterType="int">
        DELETE FROM TB_RECIPE_IMAGE WHERE RECIPE_ID = #{recipeId}
    </delete>
    
    <!-- 이미지 개별 삭제 -->
    <delete id="deleteImageById" parameterType="int">
        DELETE FROM TB_RECIPE_IMAGE WHERE RECIPE_IMAGE_ID = #{imageId}
    </delete>
    
    <!-- ===== 레시피 댓글 ===== -->
    
    <!-- 댓글 목록 조회 -->
    <select id="selectCommentsByRecipeId" parameterType="int" resultMap="RecipeCommentResultMap">
        SELECT c.*, u.USER_NICKNAME
        FROM TB_RECIPE_COMMENT c
        LEFT JOIN TB_USER u ON c.USER_ID = u.USER_ID
        WHERE c.RECIPE_ID = #{recipeId}
        ORDER BY c.CREATED_AT ASC
    </select>
    
    <!-- 댓글 추가 -->
    <insert id="insertComment" parameterType="com.moc.pro.recipe.vo.RecipeCommentVO">
        INSERT INTO TB_RECIPE_COMMENT (
            RECIPE_ID, USER_ID, RECIPE_COMMENT_CONTENT,
            CREATED_AT, CREATED_BY
        ) VALUES (
            #{recipeId}, #{userId}, #{recipeCommentContent},
            SYSTIMESTAMP, #{userId}
        )
    </insert>
    
    <!-- 댓글 삭제 -->
    <delete id="deleteComment" parameterType="int">
        DELETE FROM TB_RECIPE_COMMENT WHERE RECIPE_COMMENT_ID = #{commentId}
    </delete>
    
    <!-- 댓글 작성자 확인 -->
    <select id="checkCommentAuthor" parameterType="map" resultType="int">
        SELECT COUNT(*) 
        FROM TB_RECIPE_COMMENT
        WHERE RECIPE_COMMENT_ID = #{commentId}
        AND USER_ID = #{userId}
    </select>
    
</mapper>
