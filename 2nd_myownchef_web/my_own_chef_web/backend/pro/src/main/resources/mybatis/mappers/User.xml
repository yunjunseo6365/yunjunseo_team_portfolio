<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moc.pro.user.dao.UserDAO">

    <!-- 로그인 - 아이디와 비밀번호로 사용자 조회 -->
    <select id="selectUserByIdAndPwd" parameterType="map" resultType="UserVO">
        SELECT 
            user_id,
            user_email,
            user_name,
            user_nickname,
            user_pwd,
            user_status,
            withdrawn_at,
            user_isadmin,
            created_at,
            created_by,
            updated_at,
            updated_by
        FROM tb_user
        WHERE user_id = #{userId}
          AND user_pwd = #{userPwd}
          AND user_status = 'ACTIVE'
    </select>
    
    <!-- 아이디로 사용자 조회 (BCrypt 로그인용) + 이미지 정보 JOIN -->
    <select id="selectUserById" parameterType="string" resultType="UserVO">
        SELECT 
            u.user_id,
            u.user_email,
            u.user_name,
            u.user_nickname,
            u.user_pwd,
            u.user_status,
            u.withdrawn_at,
            u.user_isadmin,
            u.created_at,
            u.created_by,
            u.updated_at,
            u.updated_by,
            COALESCE(ui.user_image_url, 'http://localhost:18880/images/default/default-profile.png') AS user_image_url,
            ui.user_image_path
        FROM tb_user u
        LEFT JOIN tb_user_image ui ON u.user_id = ui.user_id
        WHERE u.user_id = #{userId}
          AND u.user_status = 'ACTIVE'
    </select>
    
    <!-- 회원가입 - 사용자 등록 -->
    <insert id="insertUser" parameterType="UserVO">
        INSERT INTO tb_user (
            user_id,
            user_email,
            user_name,
            user_nickname,
            user_pwd,
            user_status,
            user_isadmin,
            created_at,
            created_by
        ) VALUES (
            #{userId},
            #{userEmail},
            #{userName},
            #{userNickname},
            #{userPwd},
            'ACTIVE',
            'N',
            SYSTIMESTAMP,
            #{userId}
        )
    </insert>
    
    <!-- 이메일 중복 확인 -->
    <select id="checkEmailDuplicate" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM tb_user
        WHERE user_email = #{email}
          AND user_status = 'ACTIVE'
    </select>
    
    <!-- 닉네임 중복 확인 -->
    <select id="checkNicknameDuplicate" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM tb_user
        WHERE user_nickname = #{nickname}
          AND user_status = 'ACTIVE'
    </select>
    
    <!-- 아이디 중복 확인 -->
    <select id="checkUserIdDuplicate" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM tb_user
        WHERE user_id = #{userId}
          AND user_status = 'ACTIVE'
    </select>
    
    <!-- 사용자 정보 조회 (마이페이지용) + 이미지 정보 JOIN -->
    <select id="getUserInfo" parameterType="string" resultType="UserVO">
        SELECT 
            u.user_id,
            u.user_name,
            u.user_nickname,
            u.user_email,
            u.user_isadmin,
            COALESCE(ui.user_image_url, 'http://localhost:18880/images/default/default-profile.png') AS user_image_url,
            ui.user_image_path
        FROM tb_user u
        LEFT JOIN tb_user_image ui ON u.user_id = ui.user_id
        WHERE u.user_id = #{userId}
          AND u.user_status = 'ACTIVE'
    </select>
    
    <!-- 사용자 정보 수정 (닉네임, 이메일) -->
    <update id="updateUserInfo" parameterType="UserVO">
        UPDATE tb_user
        SET user_nickname = #{userNickname},
            user_email = #{userEmail},
            updated_at = SYSTIMESTAMP,
            updated_by = #{updatedBy}
        WHERE user_id = #{userId}
          AND user_status = 'ACTIVE'
    </update>
    
    <!-- 회원 탈퇴 (논리 삭제) -->
    <update id="withdrawUser" parameterType="string">
        UPDATE tb_user
        SET user_status = 'WITHDRAWN',
            withdrawn_at = SYSTIMESTAMP,
            updated_at = SYSTIMESTAMP,
            updated_by = #{userId}
        WHERE user_id = #{userId}
          AND user_status = 'ACTIVE'
    </update>
    
    <!-- 아이디 찾기 (이름 + 이메일) -->
    <select id="findUserIdByNameAndEmail" parameterType="map" resultType="UserVO">
        SELECT 
            user_id,
            user_name,
            user_email
        FROM tb_user
        WHERE user_name = #{userName}
          AND user_email = #{userEmail}
          AND user_status = 'ACTIVE'
    </select>
    
    <!-- 사용자 프로필 이미지 업데이트 (MERGE - INSERT or UPDATE) -->
    <update id="updateUserImage" parameterType="UserVO">
        MERGE INTO tb_user_image ui
        USING (SELECT #{userId} as user_id FROM DUAL) src
        ON (ui.user_id = src.user_id)
        WHEN MATCHED THEN
            UPDATE SET 
                user_image_url = #{userImageUrl},
                user_image_path = #{userImagePath},
                updated_at = SYSTIMESTAMP,
                updated_by = #{userId}
        WHEN NOT MATCHED THEN
            INSERT (user_id, user_image_url, user_image_path, created_at, created_by)
            VALUES (#{userId}, #{userImageUrl}, #{userImagePath}, SYSTIMESTAMP, #{userId})
    </update>

</mapper>
